@import controllers.sugar.Requests.OreRequest
@import models.user.role.RoleModel
@import models.user.{Notification, User}
@import ore.user.notification.{InviteFilter, NotificationFilter}
@import ore.{OreConfig, Visitable}
@import views.html.utils.userAvatar

@import cats.data.{NonEmptyList => NEL}

@(notifications: Seq[(Notification, User)], invites: Seq[(RoleModel, Visitable)], notificationFilter: NotificationFilter,
        inviteFilter: InviteFilter)(implicit messages: Messages, request: OreRequest[_], config: OreConfig, flash: Flash)
@notificationFilterOption(option: NotificationFilter) = @{
    if (option.equals(notificationFilter)) {
        Html("selected")
    }
}
@inviteFilterOption(option: InviteFilter) = @{
    if (option.equals(inviteFilter)) {
        Html("selected")
    }
}
@formatNotification(notification: Notification) = @{
    notification.messageArgs match {
        case NEL(head, Nil) => Html(messages(head))
        case NEL(head, tail) => Html(messages(head, tail: _*))
    }
}
@bootstrap.layout(messages("notification.plural")) {

    <script type="text/javascript" src="@routes.Assets.at("javascripts/notifications.js")"></script>

    <div class="row">
        <div class="col-12 col-lg-8 mb-5">
            <div class="card">
                <div class="card-header">
                    @messages("notification.plural")
                    <div class="float-right form-inline notification-controls">
                        <select class="form-control select-notifications custom-select-sm">
                            <option @notificationFilterOption(NotificationFilter.Unread)>
                                @messages(NotificationFilter.Unread.title)
                            </option>
                            <option @notificationFilterOption(NotificationFilter.Read)>
                                @messages(NotificationFilter.Read.title)
                            </option>
                            <option @notificationFilterOption(NotificationFilter.All)>
                                @messages(NotificationFilter.All.title)
                            </option>
                        </select>

                        @if(notifications.nonEmpty && notificationFilter.equals(NotificationFilter.Unread)) {
                            <button class="btn-mark-all-read btn btn-yellow btn-sm">
                                <i class="fas fa-check fa-fw"></i> <strong>@messages("notification.markAllRead")</strong>
                            </button>
                        }
                    </div>
                </div>
                <ul class="list-group">
                    @if(notifications.isEmpty) {
                        <li class="list-group-item"><i class="fas fa-thumbs-up"></i> @messages(notificationFilter.emptyMessage)</li>
                    }
                    @notifications.map { case (notification, origin) =>
                        <li class="list-group-item notification" data-action="@notification.action.getOrElse("none")"
                        data-id="@notification.id.value">

                            @userAvatar(Some(origin.name), origin.avatarUrl, clazz = "user-avatar-s")
                            @formatNotification(notification)

                            @if(!notification.isRead) {
                                <i class="btn-mark-read minor float-right"><i class="fas fa-check fa-fw fa-lg"></i></i>
                            }
                        </li>
                    }
                </ul>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-header">
                    @messages("notification.invites")
                    <div class="float-right form-inline notification-controls">
                        <select class="form-control select-invites custom-select-sm">
                            <option @inviteFilterOption(InviteFilter.All)>
                            @messages(InviteFilter.All.title)
                            </option>
                            <option @inviteFilterOption(InviteFilter.Projects)>
                            @messages(InviteFilter.Projects.title)
                            </option>
                            <option @inviteFilterOption(InviteFilter.Organizations)>
                            @messages(InviteFilter.Organizations.title)
                            </option>
                        </select>
                    </div>
                </div>
                <ul class="list-group">
                    @if(invites.isEmpty) {
                        <li class="list-group-item"><i class="fas fa-thumbs-up"></i> @messages(notificationFilter.emptyMessage)</li>
                    }
                    @invites.map { case (invite, subject) =>
                        <div class="list-group-item">
                            <div class="invite-content" data-id="@invite.id.value" data-type="@subject.getClass.getSimpleName.toLowerCase">
                                <span class="minor">
                                    <i class="dismiss pull-left fa fa-times" style="display: none;"></i>
                                    <span class="pull-right"><i class="fa fa-tag"></i> @subject.getClass.getSimpleName</span>
                                </span>
                                <br/>

                                <div class="invite-message invite-choice" style="display: auto;">
                                    <p>
                                        @messages("notification.invite", subject.getClass.getSimpleName.toLowerCase)
                                        <a href="@subject.url">@subject.name</a>.
                                    </p>
                                    <button class="btn btn-invite btn-accept btn-sm btn-success">
                                        @messages("notification.invite.accept")
                                    </button>
                                    <button class="btn btn-invite btn-decline btn-sm btn-danger">
                                        @Html(messages("notification.invite.decline"))
                                    </button>
                                </div>

                                <div class="invite-message invite-accepted" style="display: none;">
                                    <i class="minor fa fa-3x fa-birthday-cake"></i><br/>
                                    @Html(messages("notification.invite.joined", subject.name))<br/>
                                    <a href="@subject.url" class="btn btn-sm btn-primary">
                                        @messages("notification.invite.visit")
                                    </a>
                                    <button class="btn btn-undo btn-sm btn-info">
                                        @messages("notification.invite.undo")
                                    </button>
                                </div>

                                <div class="invite-message invite-declined" style="display: none;">
                                    <i class="minor fa fa-3x fa-times"></i>
                                    <p>@Html(messages("notification.invite.declined", subject.name))</p>
                                </div>

                                <i class="minor invite-loading fa fa-5x fa-spinner fa-spin" style="display: none;"></i>
                            </div>
                        </div>
                    }
                </ul>
            </div>
        </div>
    </div>
}
